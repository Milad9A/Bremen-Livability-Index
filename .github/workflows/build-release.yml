name: Build and Release Apps

on:
  workflow_run:
    workflows: ["Frontend Tests"]
    types:
      - completed
    branches:
      - master
      - main
  workflow_dispatch:

permissions:
  contents: write

jobs:
  # -----------------------------------------------------------------
  # Check if tests passed
  # -----------------------------------------------------------------
  check-tests:
    name: Verify Tests Passed
    runs-on: ubuntu-latest
    if: ${{ github.event.workflow_run.conclusion == 'success' || github.event_name == 'workflow_dispatch' }}
    steps:
      - name: Tests passed
        run: echo "Frontend tests passed, proceeding with build..."

  # -----------------------------------------------------------------
  # Android Build Job
  # -----------------------------------------------------------------
  build-android:
    needs: check-tests
    name: Build Android
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Java
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'
      
      - name: Set up Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.38.4'
          channel: 'stable'
          cache: true
      
      - name: Install dependencies
        working-directory: frontend/bli
        run: flutter pub get
      
      - name: Build APK
        working-directory: frontend/bli
        run: flutter build apk --release
      
      - name: Rename APK
        working-directory: frontend/bli
        run: |
          mv build/app/outputs/flutter-apk/app-release.apk BLI-Android.apk
      
      - name: Upload Android artifact
        uses: actions/upload-artifact@v4
        with:
          name: android-build
          path: frontend/bli/BLI-Android.apk

  # -----------------------------------------------------------------
  # Windows Build Job
  # -----------------------------------------------------------------
  build-windows:
    name: Build Windows
    needs: check-tests
    runs-on: windows-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.38.4'
          channel: 'stable'
          cache: true
      
      - name: Install dependencies
        working-directory: frontend/bli
        run: flutter pub get
      
      - name: Build Windows
        working-directory: frontend/bli
        run: flutter build windows --release
      
      - name: Create ZIP archive
        working-directory: frontend/bli/build/windows/x64/runner
        run: Compress-Archive -Path Release/* -DestinationPath BLI-Windows.zip
      
      - name: Upload Windows artifact
        uses: actions/upload-artifact@v4
        with:
          name: windows-build
          path: frontend/bli/build/windows/x64/runner/BLI-Windows.zip

  # -----------------------------------------------------------------
  # Linux Build Job
  # -----------------------------------------------------------------
  build-linux:
    name: Build Linux
    needs: check-tests
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Install Linux dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y clang cmake ninja-build pkg-config libgtk-3-dev liblzma-dev libstdc++-12-dev
      
      - name: Set up Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.38.4'
          channel: 'stable'
          cache: true
      
      - name: Install dependencies
        working-directory: frontend/bli
        run: flutter pub get
      
      - name: Build Linux
        working-directory: frontend/bli
        run: flutter build linux --release
      
      - name: Create tarball
        working-directory: frontend/bli/build/linux/x64/release
        run: tar -czvf BLI-Linux.tar.gz bundle/
      
      - name: Upload Linux artifact
        uses: actions/upload-artifact@v4
        with:
          name: linux-build
          path: frontend/bli/build/linux/x64/release/BLI-Linux.tar.gz

  # -----------------------------------------------------------------
  # macOS Build Job
  # -----------------------------------------------------------------
  build-macos:
    name: Build macOS
    needs: check-tests
    runs-on: macos-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.38.4'
          channel: 'stable'
          cache: true
      
      - name: Install dependencies
        working-directory: frontend/bli
        run: flutter pub get
      
      - name: Build macOS
        working-directory: frontend/bli
        run: flutter build macos --release
      
      - name: Create ZIP archive
        working-directory: frontend/bli/build/macos/Build/Products/Release
        run: zip -r BLI-macOS.zip "bli.app"
      
      - name: Upload macOS artifact
        uses: actions/upload-artifact@v4
        with:
          name: macos-build
          path: frontend/bli/build/macos/Build/Products/Release/BLI-macOS.zip

  # -----------------------------------------------------------------
  # Release Job
  # -----------------------------------------------------------------
  release:
    name: Create Unified Release
    needs: [build-android, build-windows, build-linux, build-macos]
    runs-on: ubuntu-latest
    steps:
      - name: Download artifacts
        uses: actions/download-artifact@v4
        with:
          path: ./artifacts
          merge-multiple: true # Flattens the structure so all files are in ./artifacts/
      
      - name: Get date, time, and sha
        id: meta
        run: |
          echo "date=$(date +'%Y-%m-%d')" >> $GITHUB_OUTPUT
          echo "time=$(date +'%H:%M:%S')" >> $GITHUB_OUTPUT
          echo "timestamp=$(date +'%Y%m%d-%H%M%S')" >> $GITHUB_OUTPUT
          echo "sha_short=$(echo ${GITHUB_SHA} | cut -c1-7)" >> $GITHUB_OUTPUT
      
      - name: Create Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: build-${{ steps.meta.outputs.timestamp }}-${{ steps.meta.outputs.sha_short }}
          name: BLI Build - ${{ steps.meta.outputs.date }} ${{ steps.meta.outputs.time }} (${{ steps.meta.outputs.sha_short }})
          make_latest: true
          body: |
            üöÄ **Bremen Livability Index Build**
            
            **Build Date**: ${{ steps.meta.outputs.date }}
            **Build Time**: ${{ steps.meta.outputs.time }}
            **Commit**: ${{ steps.meta.outputs.sha_short }}
            
            ---
            
            ### üì± Mobile
            - **Android**: Download `BLI-Android.apk` and install.
            
            ### üñ•Ô∏è Desktop
            - **Windows**: Extract `BLI-Windows.zip`, run `bli.exe`.
            - **Linux**: Extract `BLI-Linux.tar.gz`, run `./bundle/bli`.
            - **macOS**: Extract `BLI-macOS.zip`, run `bli.app`.
            
            > ‚ö†Ô∏è Note: Desktop apps are unsigned and may require security exceptions to run.
          files: |
            ./artifacts/BLI-Android.apk
            ./artifacts/BLI-Windows.zip
            ./artifacts/BLI-Linux.tar.gz
            ./artifacts/BLI-macOS.zip
          prerelease: false
          draft: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
