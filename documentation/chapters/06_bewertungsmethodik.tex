% !TEX root = ../main.tex
% ============================================================
\chapter{Bewertungsmethodik}
\label{ch:bewertung}
% ============================================================

Das Kernstück des Bremen Livability Index ist der Bewertungsalgorithmus, der
für einen gegebenen geographischen Punkt einen \textbf{Livability Score}
zwischen 0 und 100 berechnet.

\section{Bewertungsformel}
\label{sec:formel}

Der Score setzt sich aus einem Basiswert, der Summe positiver Faktoren und
der Summe negativer Faktoren zusammen:

\begin{equation}
  \label{eq:score}
  \text{Score} = \text{clamp}\!\left(
  \underbrace{S_{\text{base}}}_{= 40}
  + \sum_{i=1}^{9} w_i \cdot f_i^{+}
  - \sum_{j=1}^{11} w_j \cdot f_j^{-}
  ,\; 0,\; 100
  \right)
\end{equation}

Dabei ist $S_{\text{base}} = 40$ ein neutraler Ausgangswert,
$f_i^{+}$ bzw.\ $f_j^{-}$ die Einzelscores der positiven/negativen Faktoren
und $w \in \{0{,}0;\; 0{,}5;\; 1{,}0;\; 1{,}5\}$ der nutzerspezifische
Gewichtungsmultiplikator (\textit{ImportanceLevel}: \texttt{excluded},
\texttt{low}, \texttt{medium}, \texttt{high}).

Faktoren mit hohen Zählergebnissen verwenden logarithmische Skalierung
$f(n) = \min(f_{\max},\; \ln(1{+}n) \cdot k)$, die übrigen lineare
Skalierung $f(n) = \min(f_{\max},\; n \cdot k)$.

\section{Positive Faktoren}
\label{sec:positive_faktoren}

\begin{table}[H]
  \centering
  \caption{Positive Einflussfaktoren (Summe Max.: 60)}
  \label{tab:positive}
  \scriptsize
  \begin{tabularx}{\textwidth}{p{2.8cm}ccX}
    \toprule
    \textbf{Faktor} & \textbf{Max.} & \textbf{Radius} & \textbf{Formel}                                                \\
    \midrule
    Grünflächen     & 14            & 175\,m          & $\min(9, \ln(1{+}n_B) \cdot 2{,}0) + \min(5, n_P \cdot 2{,}5)$ \\
    Nahversorgung   & 10            & 550\,m          & $\min(10, \ln(1{+}n) \cdot 2{,}8)$                             \\
    ÖPNV            & 8             & 450\,m          & $\min(8, \ln(1{+}n) \cdot 3{,}5)$                              \\
    Gesundheit      & 6             & 700\,m          & $\min(6, n \cdot 2{,}5)$                                       \\
    Fahrrad         & 6             & 275\,m          & $\min(6, \ln(1{+}n) \cdot 2{,}5)$                              \\
    Bildung         & 5             & 500\,m          & $\min(5, n \cdot 1{,}5)$                                       \\
    Sport/Freizeit  & 4             & 700\,m          & $\min(4, \ln(1{+}n) \cdot 1{,}8)$                              \\
    Kultur          & 4             & 500\,m          & $\min(4, n \cdot 2{,}0)$                                       \\
    Fußgänger       & 3             & 275\,m          & $\min(3, \ln(1{+}n) \cdot 1{,}2)$                              \\
    \bottomrule
  \end{tabularx}
\end{table}

\section{Negative Faktoren}
\label{sec:negative_faktoren}

\begin{table}[H]
  \centering
  \caption{Negative Einflussfaktoren (Summe Max.: 57)}
  \label{tab:negative}
  \scriptsize
  \begin{tabularx}{\textwidth}{p{2.8cm}ccX}
    \toprule
    \textbf{Faktor} & \textbf{Strafe} & \textbf{Radius} & \textbf{Typ}             \\
    \midrule
    Industriegebiet & 10              & 150\,m          & Binär                    \\
    Unfälle         & 8               & 120\,m          & $\min(8, n \cdot 2{,}0)$ \\
    Flughafen       & 7               & 600\,m          & Binär                    \\
    Hauptstraßen    & 6               & 60\,m           & Binär                    \\
    Lärmquellen     & 6               & 75\,m           & $\min(6, n \cdot 2{,}0)$ \\
    Abfall          & 5               & 250\,m          & Binär                    \\
    Eisenbahn       & 5               & 100\,m          & Binär                    \\
    Tankstelle      & 3               & 75\,m           & Binär                    \\
    Strom           & 3               & 75\,m           & Binär                    \\
    Baustelle       & 2               & 125\,m          & Binär                    \\
    Großparkplatz   & 2               & 50\,m           & Binär                    \\
    \bottomrule
  \end{tabularx}
\end{table}

Binäre Faktoren vergeben die volle Strafe, sobald mindestens ein Objekt
im Radius vorhanden ist. Zählerbasierte (Unfälle, Lärm) steigen
proportional, sind aber nach oben begrenzt. Die Suchradien
(50\,--\,700\,m) spiegeln den Einflussbereich der Faktoren wider;
alle Abfragen nutzen \texttt{ST\_DWithin} auf dem \acrshort{wgs84}-Ellipsoid.

\section{Score-Interpretation und Implementierung}

Die App visualisiert den Score durch eine dreistufige Farbcodierung
(Tabelle~\ref{tab:farbcodierung}). Der numerische Wert wird direkt angezeigt.

\begin{table}[H]
  \centering
  \caption{Farbcodierung des Livability Scores}
  \label{tab:farbcodierung}
  \begin{tabular}{ccl}
    \toprule
    \textbf{Score-Bereich} & \textbf{Farbe} & \textbf{Bewertung} \\
    \midrule
    $\geq 70$   & \textcolor{OliveGreen}{\rule{1em}{1em}} Grün   & Gut    \\
    $50$--$69$  & \textcolor{Orange}{\rule{1em}{1em}} Orange      & Mittel \\
    $< 50$      & \textcolor{BrickRed}{\rule{1em}{1em}} Rot       & Schlecht \\
    \bottomrule
  \end{tabular}
\end{table}

Abbildung~\ref{fig:score_fluss} veranschaulicht den Berechnungsfluss
des Algorithmus: Der Basiswert wird mit den gewichteten positiven und
negativen Teilscores verrechnet und das Ergebnis auf $[0,\;100]$ begrenzt.

\begin{figure}[H]
  \centering
  \begin{tikzpicture}[
    node distance=0.6cm and 1.2cm,
    box/.style={draw, rounded corners, minimum width=2.6cm,
                minimum height=0.9cm, align=center, font=\small},
    sumbox/.style={box, fill=OliveGreen!15},
    penbox/.style={box, fill=BrickRed!12},
    basebox/.style={box, fill=gray!15},
    resbox/.style={box, fill=NavyBlue!15, font=\small\bfseries},
    arr/.style={-{Stealth[length=5pt]}, thick}
  ]
    % Base score
    \node[basebox] (base) {$S_{\text{base}} = 40$};

    % Positive factors
    \node[sumbox, below left=1.0cm and 0.4cm of base] (pos) {%
      $\displaystyle\sum w_i \cdot f_i^{+}$\\[2pt]
      {\scriptsize(9 Faktoren, max.\,60)}};

    % Negative factors
    \node[penbox, below right=1.0cm and 0.4cm of base] (neg) {%
      $\displaystyle\sum w_j \cdot f_j^{-}$\\[2pt]
      {\scriptsize(11 Faktoren, max.\,57)}};

    % Aggregation
    \node[box, below=1.6cm of base, fill=yellow!12] (agg) {%
      $S_{\text{base}} + \Sigma^{+} - \Sigma^{-}$};

    % Clamp
    \node[resbox, below=0.7cm of agg] (clamp) {%
      $\text{clamp}(0,\;100)$};

    % Final
    \node[resbox, below=0.7cm of clamp, fill=OliveGreen!25] (result) {%
      Livability Score};

    % Arrows
    \draw[arr] (base)  -- (agg);
    \draw[arr] (pos)   -- (agg);
    \draw[arr] (neg)   -- (agg);
    \draw[arr] (agg)   -- (clamp);
    \draw[arr] (clamp) -- (result);
  \end{tikzpicture}
  \caption{Berechnungsfluss des Livability Scores}
  \label{fig:score_fluss}
\end{figure}

Der Algorithmus ist in \texttt{LivabilityScorer} (\texttt{core/scoring.py})
implementiert. Jeder Faktor wird durch eine eigene statische Methode berechnet;
\texttt{calculate\_score} aggregiert alle Beiträge zu einem
\texttt{LivabilityScoreResponse}-Objekt. Listing~\ref{lst:score_agg} zeigt
den zentralen Aggregationsschritt.

\begin{lstlisting}[style=python, caption={Aggregation in \texttt{calculate\_score}}, label={lst:score_agg}]
positive = (greenery + amenities + transport + healthcare
            + bike_infra + education + sports
            + pedestrian + cultural)
negative = (accident_penalty + industrial_penalty
            + roads_penalty + noise_penalty
            + railway_penalty + gas_station_penalty
            + waste_penalty + power_penalty
            + parking_penalty + airport_penalty
            + construction_penalty)
final_score = max(0.0, min(100.0,
                  cls.BASE_SCORE + positive - negative))
\end{lstlisting}
